'use strict';
var noise = require('./js/noise.js');
//var fs = require('fs');
var _ = require('lodash');

var debug = true;
var start = process.hrtime();

var elapsed_time = function(note){
    var precision = 3; // 3 decimal places
    var elapsed = process.hrtime(start)[1] / 1000000; // divide by a million to get nano to milli
    console.log(process.hrtime(start)[0] + " s, " + elapsed.toFixed(precision) + " ms - " + note); // print message + time
    start = process.hrtime(); // reset the timer
}


exports.Map = function(){
	this.mapData = { 	
		"height":64,
		"width":64,
		"version":1,
		"tileheight":16,
		"tilewidth":16,
		"orientation":"orthogonal",
		"layers":[{
				"data":[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 53, 53, 19, 19, 36, 19, 19, 37, 19, 36, 19, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 54, 57, 19, 19, 36, 36, 19, 20, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 19, 19, 37, 38, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 54, 19, 36, 19, 36, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 19, 19, 22, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 19, 39, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 19, 21, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 19, 19, 38, 21, 19, 50, 0, 49, 0, 0, 0, 49, 50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 47, 48, 0, 0, 0, 49, 50, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 53, 19, 19, 22, 67, 3, 66, 5, 2, 6, 66, 67, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 64, 65, 5, 2, 6, 66, 67, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 19, 39, 19, 19, 37, 19, 19, 36, 19, 22, 23, 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 19, 37, 19, 19, 36, 19, 22, 23, 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 9, 0, 0, 0, 0, 52, 19, 19, 36, 19, 19, 21, 19, 19, 39, 40, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 19, 36, 19, 19, 38, 19, 19, 39, 40, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 19, 41, 0, 0, 0, 0, 0, 25, 53, 54, 53, 53, 55, 53, 54, 55, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 53, 54, 53, 53, 55, 53, 54, 55, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 57, 53, 60, 0, 0, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 6, 5, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 54, 55, 57, 58, 0, 0, 0, 0, 0, 0, 8, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 19, 41, 0, 0, 0, 0, 0, 0, 0, 50, 8, 19, 6, 2, 3, 6, 7, 0, 0, 0, 0, 0, 0, 13, 14, 0, 0, 0, 0, 0, 0, 13, 14, 0, 0, 0, 0, 1, 34, 6, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 57, 53, 60, 0, 0, 0, 0, 0, 0, 1, 67, 19, 19, 36, 19, 22, 23, 24, 0, 0, 0, 0, 0, 1, 30, 31, 9, 0, 0, 0, 0, 1, 30, 31, 9, 0, 0, 0, 59, 55, 57, 60, 0, 0, 0, 0, 0, 0, 47, 48, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 19, 19, 19, 19, 19, 19, 39, 40, 41, 0, 0, 0, 0, 0, 25, 19, 19, 26, 0, 0, 0, 0, 25, 19, 19, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 64, 65, 9, 0, 0, 0, 0, 0, 46, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 19, 19, 19, 19, 19, 20, 54, 55, 57, 60, 0, 0, 0, 0, 0, 59, 57, 53, 60, 0, 0, 0, 0, 59, 57, 53, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 56, 60, 0, 0, 0, 0, 1, 5, 19, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 57, 54, 53, 19, 19, 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 53, 19, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 19, 43, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 58, 0, 0, 0, 0, 14, 14, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 43, 0, 0, 0, 0, 0, 0, 47, 48, 0, 0, 0, 0, 0, 47, 48, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 31, 31, 31, 9, 17, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 9, 0, 0, 0, 1, 4, 64, 65, 2, 3, 4, 5, 2, 64, 65, 3, 6, 7, 0, 1, 2, 2, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 19, 36, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 25, 19, 26, 0, 0, 0, 18, 19, 19, 19, 19, 19, 37, 19, 19, 36, 19, 22, 23, 24, 0, 18, 19, 19, 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 6, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 19, 43, 0, 0, 0, 25, 19, 19, 19, 19, 36, 19, 19, 19, 19, 19, 39, 40, 41, 0, 18, 19, 19, 19, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 19, 41, 0, 0, 0, 42, 19, 19, 19, 53, 54, 53, 53, 55, 53, 54, 55, 57, 60, 0, 59, 56, 56, 56, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 6, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 19, 19, 43, 0, 0, 0, 18, 19, 19, 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 49, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 19, 19, 19, 26, 0, 0, 0, 35, 19, 19, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 66, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 53, 54, 19, 37, 26, 0, 0, 0, 52, 56, 56, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 43, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 13, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 19, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 2, 30, 30, 31, 2, 6, 7, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 57, 57, 58, 0, 0, 0, 0, 0, 0, 0, 0, 25, 19, 43, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 20, 21, 22, 23, 19, 19, 19, 19, 19, 19, 19, 6, 3, 30, 4, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 41, 0, 49, 50, 51, 0, 47, 48, 0, 0, 0, 1, 36, 37, 38, 39, 40, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 19, 19, 3, 66, 67, 68, 2, 64, 65, 6, 2, 3, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 57, 57, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 19, 20, 19, 19, 19, 19, 19, 37, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 0, 0, 0, 0, 0, 1, 7, 0, 0, 0, 0, 0, 0, 0, 1, 9, 0, 0, 0, 0, 18, 37, 19, 19, 19, 19, 19, 20, 19, 19, 38, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 4, 4, 30, 9, 0, 0, 0, 0, 0, 0, 0, 52, 58, 0, 0, 0, 0, 0, 1, 2, 19, 41, 0, 0, 0, 0, 35, 19, 19, 20, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 19, 19, 19, 19, 9, 13, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 53, 56, 58, 0, 0, 0, 0, 18, 19, 38, 19, 19, 19, 19, 56, 56, 56, 19, 19, 19, 19, 56, 56, 56, 54, 56, 56, 53, 56, 56, 54, 56, 60, 0, 0, 0, 0, 0, 0, 0, 0, 1, 5, 19, 19, 19, 19, 19, 19, 19, 9, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 25, 19, 19, 19, 56, 56, 60, 0, 0, 0, 18, 19, 57, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 19, 19, 19, 19, 19, 19, 19, 19, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 56, 60, 0, 0, 0, 0, 0, 0, 35, 43, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 19, 19, 19, 19, 19, 56, 56, 56, 56, 56, 19, 3, 4, 4, 4, 5, 6, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 43, 0, 0, 0, 0, 0, 0, 0, 0, 52, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 4, 4, 19, 19, 19, 19, 19, 19, 60, 0, 0, 0, 0, 0, 35, 19, 37, 38, 19, 19, 19, 41, 0, 0, 0, 0, 0, 1, 9, 0, 0, 0, 0, 0, 35, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 13, 0, 0, 0, 1, 4, 4, 4, 19, 22, 23, 19, 19, 19, 19, 56, 56, 60, 0, 0, 0, 0, 0, 0, 52, 55, 54, 53, 54, 57, 54, 58, 0, 0, 0, 0, 1, 19, 19, 9, 0, 0, 0, 0, 18, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 4, 30, 4, 4, 4, 19, 19, 19, 19, 19, 39, 40, 19, 19, 19, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 58, 0, 0, 0, 0, 1, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 59, 19, 19, 19, 19, 19, 56, 56, 53, 56, 56, 56, 56, 53, 56, 56, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 56, 56, 56, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 42, 19, 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 2, 9, 0, 0, 0, 0, 0, 0, 1, 19, 19, 19, 9, 0, 0, 0, 0, 0, 0, 0, 1, 34, 19, 19, 19, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 19, 19, 24, 0, 0, 0, 0, 0, 1, 19, 19, 19, 19, 58, 0, 0, 0, 0, 0, 0, 1, 19, 19, 19, 19, 19, 41, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 4, 4, 5, 5, 6, 5, 2, 4, 5, 6, 4, 2, 6, 4, 7, 0, 0, 0, 0, 0, 0, 1, 5, 19, 19, 19, 41, 0, 0, 0, 0, 0, 52, 56, 56, 56, 58, 0, 0, 0, 0, 0, 0, 1, 19, 19, 19, 19, 21, 36, 19, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 57, 53, 53, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 24, 0, 0, 0, 0, 0, 0, 52, 19, 19, 19, 19, 24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 19, 19, 19, 36, 38, 19, 19, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 57, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 5, 9, 0, 0, 0, 0, 0, 35, 19, 19, 19, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 19, 19, 19, 19, 19, 19, 19, 19, 41, 0, 0, 0, 0, 0, 1, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 19, 19, 19, 19, 19, 54, 53, 53, 54, 55, 55, 58, 0, 0, 0, 0, 0, 52, 56, 56, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 42, 19, 21, 19, 19, 20, 37, 19, 19, 26, 0, 0, 0, 0, 0, 52, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 19, 54, 53, 53, 58, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 19, 19, 20, 19, 19, 38, 19, 19, 19, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 18, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 47, 48, 0, 0, 35, 19, 19, 20, 36, 19, 19, 20, 19, 19, 19, 5, 9, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 35, 43, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 17, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 5, 6, 7, 0, 0, 0, 1, 64, 7, 0, 1, 19, 19, 37, 22, 23, 37, 19, 19, 22, 19, 19, 19, 41, 0, 0, 0, 47, 48, 0, 47, 48, 0, 47, 48, 0, 1, 5, 19, 43, 0, 13, 14, 14, 13, 14, 14, 0, 0, 0, 0, 1, 5, 34, 9, 0, 0, 49, 49, 50, 0, 0, 1, 19, 19, 19, 19, 9, 0, 1, 19, 19, 19, 6, 19, 19, 38, 19, 39, 40, 19, 19, 19, 39, 19, 19, 19, 19, 5, 5, 5, 64, 65, 5, 64, 65, 5, 64, 65, 5, 19, 19, 19, 19, 2, 30, 31, 31, 30, 31, 31, 5, 2, 3, 2, 21, 22, 23, 19, 5, 5, 66, 66, 67, 5, 5, 19, 19, 19, 19, 19, 19, 6, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19, 19],
				"height":1000,
				"width":1000,
				"collision":false,
				"name":"Tile Layer 1",
				"type":"tilelayer"
			}],
		"tilesets":[{
			"firstgid":1,
					"image":"tiles-1.png",
			 "imageheight":64,
         "imagewidth":272,
			"margin":0,

			"name":"tiles-1",
			"properties":{},
			"spacing":0,
			"tileheight":16,
			"tilewidth":16
		}]
	};
	this.canvas = null;
	this.context = null;
	this.imageData = null;
	this.threshold = 170;//170
	this.spawnThreshold = 240;
	this.width = 1000;
	this.height = 1000;
	this.tileEnum = {none: 0, empty: 1, ground: 2, 
					br_peice:51, tr_peice:50, bl_peice: 52, tl_peice: 49,
					top_side: 17, bottom_side: 19, right_side: 18, left_side: 20,
					br_corner: 35, tr_corner:34, bl_corner: 36, tl_corner: 33};

	this.playerSpawnPoints = [];
	this.itemSpawnPoints = [];
	this.items = [];
};

exports.Map.prototype = {
	noiseGen: function() {
		var defaultPresetArgs = {
			seed: (new Date()).toString(),
			color: 'greyscale',
			noiseFunction: 'perlin_classic', // value , simplex , perlin_classic , perlin_improved
			smoothing: 'quintic', // quintic, hermite, cosine
			scale: 33,
			size: 178,
			octaves: 3,
			persistence: 0.1,
			lacunarity: 3,
			gradientStart: '000000',
			gradientEnd: 'ffffff',
			independent: false,
			octaveFunction: 'none',
			customOctaveFunction: 'return n;',
			sumFunction: 'modular',
			customSumFunction: 'return n;',
			sineFrequencyCoeff: 1,
			modularAmplitude: 2
		};
		this.imageData = { height: this.height, width: this.width, data: new Array()};
		this.imageData = noise.Noise.update({ 
			action: 'update',
			imageData: this.imageData,
			args: defaultPresetArgs 
		});
	},

	create: function () {
		console.log('Creating New Map...');
		//this.noiseGen();
	//-	this.parseNoise();
		//fs.writeFile('file', JSON.stringify(this.mapData.layers));
		console.log('Done Creating Map!');
	},


	getColorOfTile: function(x,y){
		return {
			red: this.imageData.data[((this.imageData.width * y) + x) * 4],
			green: this.imageData.data[((this.imageData.width * y) + x) * 4 + 1],
			blue: this.imageData.data[((this.imageData.width * y) + x) * 4 + 2],
			alpha: this.imageData.data[((this.imageData.width * y) + x) * 4 + 3]
		};
	},

	getRandomPlayerSpawn: function(){
		var tile = this.playerSpawnPoints[parseInt(Math.random()*this.playerSpawnPoints.length)];
		tile.x *= this.mapData.tilewidth ;
		tile.y *= this.mapData.tileheight ;
		return tile;
	},

	getRandomItemSpawn: function(){
		var tile = this.itemSpawnPoints[parseInt(Math.random()*this.itemSpawnPoints.length)];
		tile.x *= this.mapData.tilewidth ;
		tile.y *= this.mapData.tileheight ;
		return tile;
	},

	getNewMapUpdate: function(newTile, oldTile){
		var length = 10;
		var tileUpdate = {};
		tileUpdate.x = newTile.x - length;
		tileUpdate.y = newTile.y - length;
		tileUpdate.width  = length * 2 + 1;
		tileUpdate.height = length * 2 + 1;
		tileUpdate.layers = [];
		tileUpdate = {
			x: newTile.x - length,
			y: newTile.y - length,
			width: length * 2 + 1, 
			height: length * 2 + 1, 
			tiles: [],
			items: []
		};

		if(debug) elapsed_time("recieved  update request, starting map");
		
		for(var y = newTile.y - length; y <= newTile.y  + length; y++){
			for(var x = newTile.x - length; x <= newTile.x + length; x++){

				//TODO has a bug where some tiles arent sent.
				if(oldTile.x !== undefined && oldTile.y !== undefined){
					if(newTile.x > oldTile.x  && x < oldTile.x + length)
						//continue;
						if(newTile.y === oldTile.y)
							continue;
						if(newTile.y > oldTile.y && y < oldTile.y + length)
							continue;
						if(newTile.y < oldTile.y  && y > oldTile.y - length)
							continue;
					if(newTile.x < oldTile.x  && x > oldTile.x - length)
						//continue;
						if(newTile.y === oldTile.y)
							continue;
						if(newTile.y > oldTile.y  && y < oldTile.y + length)
							continue;
						if(newTile.y < oldTile.y  && y > oldTile.y - length)
							continue;
				}

				for(var layerIndex = 0; layerIndex < this.mapData.layers.length; layerIndex++){
					if(this.mapData.layers[layerIndex].data[y]){
						var tileData = this.mapData.layers[layerIndex].data[y][x];
						if(tileData){
							tileUpdate.tiles.push({
								x:x, 
								y:y, 
								layer:layerIndex, 
								tile:tileData
							});
						}
					}
				}
				if(this.items[y]){
					var items = this.items[y][x];
					if(items){
						for(var itemIndex = 0; itemIndex < items.length; itemIndex++){
							tileUpdate.items.push(items[itemIndex]);
						}
					}
				}
			}
		}
		if(debug) elapsed_time("finished map update");
		return tileUpdate;
	},
	distanceBetween: function (source, target) {

        var _dx = source.x - target.x;
        var _dy = source.y - target.y;
        
        return Math.sqrt(_dx * _dx + _dy * _dy);

    }
};